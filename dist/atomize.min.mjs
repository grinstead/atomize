var n={},p={},q={},r={},t={};
function v(a){return function(b){function c(h){var k=void 0===h?a.o:null===h?a.i:"boolean"===typeof h?a.g:"number"===typeof h?a.j:"string"===typeof h?a.l:"function"===typeof h?a.h:"symbol"===typeof h?a.m:h instanceof Map?a.Map:h instanceof Set?a.Set:Array.isArray(h)?a.Array:(k=Object.getPrototypeOf(h))&&k!==Object.prototype?a.instance:a.object;var w=m,x=e,D=f.length;m=h;e=u;k(h,d)?0<=e&&g.set(h,~e):0>e&&g.delete(h);if(D===f.length)throw Error("Value encoded into nothing "+String(h));m=w;e=x}function d(h,
k){if(k===n)f.push(h);else if(k===p)h===(h|0)&&f.push(0),f.push(h);else if(k===r)l.push(f.push(h)-1);else if(k===t){k=l.pop();var w=f.length,x=w<<3|f[k];if(x>>3!==w)throw Error("value too large to encode "+String(h));f[k]=x}else if(h===q)m!==n&&(0<=e&&(e=~e),g.set(m,e),m=n);else if(0<=e&&(e=~e,g.set(m,0)),u++,k=g.get(h),null!=k){if(0===k)throw Error("infinite loop when encoding "+h);f.push(k)}else c(h)}var f=[],g=new Map,l=[],u=0,e=0,m=n;c(b);return f}}function y(a,b){b(void 0,n)}
function z(a,b){b(null,n)}function A(a,b){b(a,n)}function B(a,b){if(a===(a|0))return b(a,p),!0;b(a,n);return a===a}function C(a,b){b(q);b(1,r);for(var c=a.length,d=0;d<c;d++)b(a[d]);b(a,t);return!0}function E(a,b){b(a,n);return!0}function F(a,b){b(q);b(3,r);a.forEach(function(c,d){b(d)});b(a,t);a.forEach(function(c){b(c)});return!0}function G(a,b){b(q);b(4,r);a.forEach(function(c){b(c)});b(a,t);return!0}
function H(a,b){b(q);b(2,r);for(var c=Object.keys(a),d=c.length,f=0;f<d;f++)b(c[f]);b(a,t);for(f=0;f<d;f++)b(a[c[f]]);return!0}function I(a,b){return a?function(c,d){d(5,r);var f=a(c,d);d(c,t);return f}:b}
function J(a,b,c,d){if(d!==(d|0))return d;if(0>d)return a[~d];switch(d&7){case 0:return c();case 1:var f=[];a.push(f);K(a,f,b,c,d>>3);return n;case 2:f={};a.push(f);var g=[];K(a,g,b,c,d>>3);d=g.length;for(var l=0;l<d;l++)f[g[l]]=L(a,b,c);return n;case 3:f=new Map;a.push(f);g=[];K(a,g,b,c,d>>3);d=g.length;for(l=0;l<d;l++)f.set(g[l],L(a,b,c));return n;case 4:f=new Set;a.push(f);g=[];K(a,g,b,c,d>>3);d=g.length;for(l=0;l<d;l++)f.add(g[l]);return n;case 5:return b(function(){return L(a,b,c)});default:throw Error("Rebuilder TODO "+
d);}}function L(a,b,c){var d=a.length;b=J(a,b,c,c());if(b===n)return a[d];a.push(b);return b}function K(a,b,c,d,f){for(var g=d(f);g!==t;g=d(f)){var l=a.length;g=J(a,c,d,g);g===n?b.push(a[l]):(a.push(g),b.push(g))}}function M(a,b){do{var c=a&127;a>>>=7;b.push(a?c|128:c)}while(a)};function N(a){throw Error("No way to atomize "+String(a));}function O(a,b){b(a,p);return!0}export const AS_IS=p;export const atomizer=function(a){a=void 0===a?{}:a;var b=a.keepUnknownsAsIs?O:N;return v({o:I(a["void"],y),i:I(a["null"],z),g:I(a["boolean"],A),j:I(a.number,B),Array:I(a.Array,C),l:I(a.string,E),Map:I(a.Map,F),Set:I(a.Set,G),object:I(a.object,H),h:I(a["function"],b),m:I(a.symbol,b),instance:I(a.instance,b)})};
export const rebuilder=function(a){return function(b){var c=0,d=b.length,f=L([],a,function(g){if(c===g)return t;if(c===d)throw Error("Incomplete data");return b[c++]});if(c!==d)throw Error("rebuilder given excess content");return f}};
export const serialize=function(a){function b(){var e=a[d++];if(e===p||e!==(e|0)){var m=e===p?a[d++]:e;if(m!==m)c.push(4);else if(void 0===m)c.push(0);else if(null===m)c.push(1);else if("boolean"===typeof e)c.push(e?2:3);else if("string"===typeof e)f||(f=new TextEncoder),e=f.encode(e),M(e.byteLength,c),c.push(e);else throw Error("TODO serialize "+String(e));}else if(0>e)M(~e<<1|1,c);else switch(M(e<<1,c),m=e>>3,e&7){case 1:case 4:for(;d<m;)b();break;case 2:case 3:for(e=0;d<m;)e++,b();for(;0<e;e--)b();
break;case 5:for(;d<m;)b()}}var c=[],d=0,f=null;b();var g=c.reduce(function(e,m){return e+("number"===typeof m?1:m.byteLength)},0),l=new Uint8Array(g),u=0;c.forEach(function(e){"number"===typeof e?l[u++]=e:(l.set(e,u),u+=e.byteLength)});return l};
