var n={},r={},t={},w={},x={};
function y(c,b){return function(f){function g(a,d){if(d===n)e.push(a);else if(d===r)a===(a|0)&&e.push(0),e.push(a);else if(d===w)h.push(e.push(a)-1);else if(d===x){d=h.pop();var l=e.length,p=l<<3|e[d];if(p>>3!==l)throw Error("value too large to encode "+String(a));e[d]=p}else if(a===t)q!==n&&(0<=m&&(m=~m),k.set(q,m),q=n);else if(0<=m&&(m=~m,k.set(q,0)),u++,d=k.get(a),null!=d){if(0===d)throw Error("infinite loop when encoding "+a);e.push(d)}else{d=void 0===a?b.o:null===a?b.i:"boolean"===typeof a?b.g:
"number"===typeof a?b.j:"string"===typeof a?b.l:"function"===typeof a?b.h:"symbol"===typeof a?b.m:a instanceof Map?b.Map:a instanceof Set?b.Set:Array.isArray(a)?b.Array:(d=Object.getPrototypeOf(a))&&d!==Object.prototype?b.instance:b.object;l=q;p=m;var v=e.length;q=a;m=u;d(a,g)?0<=m&&k.set(a,~m):0>m&&k.delete(a);if(v===e.length)throw Error("Value encoded into nothing "+String(a));q=l;m=p}}var e=[],k=new Map(c),h=[],u=k.size-1,m=0,q=n;console.log("start",k);g(f,null);return e}}
function z(c,b){b(void 0,n)}function A(c,b){b(null,n)}function C(c,b){b(c,n)}function D(c,b){if(c===(c|0))return b(c,r),!0;b(c,n);return c===c}function E(c,b){b(t);b(1,w);for(var f=c.length,g=0;g<f;g++)b(c[g]);b(c,x);return!0}function F(c,b){b(c,n);return!0}function G(c,b){b(t);b(3,w);c.forEach(function(f,g){b(g)});b(c,x);c.forEach(function(f){b(f)});return!0}function H(c,b){b(t);b(4,w);c.forEach(function(f){b(f)});b(c,x);return!0}
function I(c,b){b(t);b(2,w);for(var f=Object.keys(c),g=f.length,e=0;e<g;e++)b(f[e]);b(c,x);for(e=0;e<g;e++)b(c[f[e]]);return!0}function J(c,b){return c?function(f,g){g(5,w);var e=c(f,g);g(f,x);return e}:b}
function K(c,b,f,g){if(g!==(g|0))return g;if(0>g)return c[~g];switch(g&7){case 0:return f();case 1:var e=[];c.push(e);L(c,e,b,f,g>>3);return n;case 2:e={};c.push(e);var k=[];L(c,k,b,f,g>>3);g=k.length;for(var h=0;h<g;h++)e[k[h]]=M(c,b,f);return n;case 3:e=new Map;c.push(e);k=[];L(c,k,b,f,g>>3);g=k.length;for(h=0;h<g;h++)e.set(k[h],M(c,b,f));return n;case 4:e=new Set;c.push(e);k=[];L(c,k,b,f,g>>3);g=k.length;for(h=0;h<g;h++)e.add(k[h]);return n;case 5:return b(function(){return M(c,b,f)});default:throw Error("Rebuilder TODO "+
g);}}function M(c,b,f){var g=c.length;b=K(c,b,f,f());if(b===n)return c[g];c.push(b);return b}function L(c,b,f,g,e){for(var k=g(e);k!==x;k=g(e)){var h=c.length;k=K(c,f,g,k);k===n?b.push(c[h]):(c.push(k),b.push(k))}};function N(c){throw Error("No way to atomize "+String(c));}function O(c,b){b(c,r);return!0}export const AS_IS=r;
export const atomizer=function(c){c=void 0===c?{}:c;var b=c.keepUnknownsAsIs?O:N;b={o:J(c["void"],z),i:J(c["null"],A),g:J(c["boolean"],C),j:J(c.number,D),Array:J(c.Array,E),l:J(c.string,F),Map:J(c.Map,G),Set:J(c.Set,H),object:J(c.object,I),h:J(c["function"],b),m:J(c.symbol,b),instance:J(c.instance,b)};var f=[],g;null==(g=c.dictionary)||g.forEach(function(e,k){f.push([e,k])});return y(f,b)};
export const rebuilder=function(c){return function(b){var f=0,g=b.length,e=M([],c,function(k){if(f===k)return x;if(f===g)throw Error("Incomplete data");return b[f++]});if(f!==g)throw Error("rebuilder given excess content");return e}};
export const serialize=function(c){function b(){var a=c[k++];if(0===a||a!==(a|0)){var d=0===a?c[k++]:a;if(d!==d)f(80);else if(void 0===d)f(16);else if(null===d)f(32);else if("boolean"===typeof d)f(d?48:64);else if("number"===typeof d)if(d===(d|0)){d=0<=d?d<<1:-d<<1|1;var l=127&d<<3|4;if(d>>>=4){for(a=[l|128];d;)l=d&127,d>>>=7,a.push(d?l|128:l);h+=a.length;e.push(new Uint8Array(a))}else f(l)}else l=new Uint8Array(8),(new DataView(l.buffer)).setFloat64(0,d),f(96),h+=8,e.push(l);else"string"===typeof d?
(u||(u=new TextEncoder),l=g(13),d=u.encode(d),h+=d.byteLength,e.push(d),l()):console.error("TODO serialize "+String(d))}else if(0>a){d=~a<<2|2;do l=d&127,d>>>=7,f(d?l|128:l);while(d)}else{var p=a&7;d=a>>3;l=g(p<<1|1);switch(p){case 1:case 4:case 5:for(;k<d;)b();l();break;case 2:case 3:for(a=0;k<d;)a++,b();l();for(d=a;0<d;d--)b();break;default:throw Error("impossible "+a);}}}function f(a){h++;e.push(a)}function g(a){var d=e.push(0)-1,l=h;return function(){var p=h-l,v=127&p<<4|a;if(p>>>=3){for(var B=
[v|128];p;)v=p&127,p>>>=7,B.push(p?v|128:v);h+=B.length;e[d]=new Uint8Array(B)}else h++,e[d]=v}}var e=[],k=0,h=0,u=null;b();var m=new Uint8Array(h),q=0;e.forEach(function(a){"number"===typeof a?m[q++]=a:(m.set(a,q),q+=a.byteLength)});return m};
export const deserializer=function(c){var b=null;return function(f){function g(a){if(null!=m)return a=m,m=null,a;if(h===a)return x;if(h===u)throw Error("Incomplete data");a=f[h++];if(a&1)switch(a&15){case 13:a=e(a,4);a=h+a;var d=f.subarray(h,a);h=a;b||(b=new TextDecoder);return b.decode(d);default:return d=e(a,4),h+d<<3|7&a>>1}else{if(a&2)return~e(a,2);if(a&4)return a=e(a,3),m=a&1?-(a>>>1):a>>>1,0;switch(a){case 16:break;case 32:return null;case 48:return!0;case 64:return!1;case 80:return NaN;case 96:return k||
(k=new DataView(f.buffer,f.byteOffset,f.byteLength)),a=k.getFloat64(h),h+=8,a;default:throw Error("bad byte "+a);}}}function e(a,d){var l=7-d;for(d=(127&a)>>d;a&128;)a=f[h++],d|=(a&127)<<l,l+=7;return d}var k=null,h=0,u=f.length,m=null,q=M([],c,function(a){var d=h;a=g(a);if(h<d)throw"fail";return a});if(h!==u)throw Error("deserializer given excess content");return q}};
