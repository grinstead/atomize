var n={},q={},t={},u={},w={};
function y(a){return function(b){function e(c){var d=void 0===c?a.o:null===c?a.i:"boolean"===typeof c?a.g:"number"===typeof c?a.j:"string"===typeof c?a.l:"function"===typeof c?a.h:"symbol"===typeof c?a.m:c instanceof Map?a.Map:c instanceof Set?a.Set:Array.isArray(c)?a.Array:(d=Object.getPrototypeOf(c))&&d!==Object.prototype?a.instance:a.object;var m=r,p=l,x=f.length;r=c;l=v;d(c,g)?0<=l&&h.set(c,~l):0>l&&h.delete(c);if(x===f.length)throw Error("Value encoded into nothing "+String(c));r=m;l=p}function g(c,
d){if(d===n)f.push(c);else if(d===q)c===(c|0)&&f.push(0),f.push(c);else if(d===u)k.push(f.push(c)-1);else if(d===w){d=k.pop();var m=f.length,p=m<<3|f[d];if(p>>3!==m)throw Error("value too large to encode "+String(c));f[d]=p}else if(c===t)r!==n&&(0<=l&&(l=~l),h.set(r,l),r=n);else if(0<=l&&(l=~l,h.set(r,0)),v++,d=h.get(c),null!=d){if(0===d)throw Error("infinite loop when encoding "+c);f.push(d)}else e(c)}var f=[],h=new Map,k=[],v=0,l=0,r=n;e(b);return f}}function z(a,b){b(void 0,n)}
function A(a,b){b(null,n)}function B(a,b){b(a,n)}function C(a,b){if(a===(a|0))return b(a,q),!0;b(a,n);return a===a}function D(a,b){b(t);b(1,u);for(var e=a.length,g=0;g<e;g++)b(a[g]);b(a,w);return!0}function E(a,b){b(a,n);return!0}function F(a,b){b(t);b(3,u);a.forEach(function(e,g){b(g)});b(a,w);a.forEach(function(e){b(e)});return!0}function G(a,b){b(t);b(4,u);a.forEach(function(e){b(e)});b(a,w);return!0}
function H(a,b){b(t);b(2,u);for(var e=Object.keys(a),g=e.length,f=0;f<g;f++)b(e[f]);b(a,w);for(f=0;f<g;f++)b(a[e[f]]);return!0}function I(a,b){return a?function(e,g){g(5,u);var f=a(e,g);g(e,w);return f}:b}
function J(a,b,e,g){if(g!==(g|0))return g;if(0>g)return a[~g];switch(g&7){case 0:return e();case 1:var f=[];a.push(f);K(a,f,b,e,g>>3);return n;case 2:f={};a.push(f);var h=[];K(a,h,b,e,g>>3);g=h.length;for(var k=0;k<g;k++)f[h[k]]=L(a,b,e);return n;case 3:f=new Map;a.push(f);h=[];K(a,h,b,e,g>>3);g=h.length;for(k=0;k<g;k++)f.set(h[k],L(a,b,e));return n;case 4:f=new Set;a.push(f);h=[];K(a,h,b,e,g>>3);g=h.length;for(k=0;k<g;k++)f.add(h[k]);return n;case 5:return b(function(){return L(a,b,e)});default:throw Error("Rebuilder TODO "+
g);}}function L(a,b,e){var g=a.length;b=J(a,b,e,e());if(b===n)return a[g];a.push(b);return b}function K(a,b,e,g,f){for(var h=g(f);h!==w;h=g(f)){var k=a.length;h=J(a,e,g,h);h===n?b.push(a[k]):(a.push(h),b.push(h))}}function M(a,b){do{var e=a&127;a>>>=7;b(a?e|128:e)}while(a)};function N(a){throw Error("No way to atomize "+String(a));}function O(a,b){b(a,q);return!0}export const AS_IS=q;export const atomizer=function(a){a=void 0===a?{}:a;var b=a.keepUnknownsAsIs?O:N;return y({o:I(a["void"],z),i:I(a["null"],A),g:I(a["boolean"],B),j:I(a.number,C),Array:I(a.Array,D),l:I(a.string,E),Map:I(a.Map,F),Set:I(a.Set,G),object:I(a.object,H),h:I(a["function"],b),m:I(a.symbol,b),instance:I(a.instance,b)})};
export const rebuilder=function(a){return function(b){var e=0,g=b.length,f=L([],a,function(h){if(e===h)return w;if(e===g)throw Error("Incomplete data");return b[e++]});if(e!==g)throw Error("rebuilder given excess content");return f}};
export const serialize=function(a){function b(){var c=a[h++];if(0===c||c!==(c|0)){var d=0===c?a[h++]:c;if(d!==d)e(20);else if(void 0===d)e(4);else if(null===d)e(8);else if("boolean"===typeof d)e(d?12:16);else if("string"===typeof d){v||(v=new TextEncoder);d=v.encode(d);var m=d.byteLength;M(d.byteLength,e);k+=m;f.push(d)}else console.error("TODO serialize "+String(d))}else if(0>c)M(~c<<2|2,e);else{var p=c&7;d=c>>3;m=g(p<<1|1);switch(p){case 1:case 4:case 5:for(;h<d;)b();m();break;case 2:case 3:for(c=
0;h<d;)c++,b();m();for(d=c;0<d;d--)b();break;default:throw Error("impossible "+c);}}}function e(c){k++;f.push(c)}function g(c){var d=f.push(0)-1;return function(){var m=k,p=127&m<<4|c;if(m>>>=3){for(var x=[p|128];m;)p=m&127,m>>>=7,x.push(m?p|128:p);k+=x.length;f[d]=new Uint8Array(x)}else k++,f[d]=p}}var f=[],h=0,k=0,v=null;b();var l=new Uint8Array(k),r=0;f.forEach(function(c){"number"===typeof c?l[r++]=c:(l.set(c,r),r+=c.byteLength)});return l};
