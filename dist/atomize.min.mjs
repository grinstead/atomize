var p={},r={},t={},w={},x={};
function y(a){return function(b){function f(d){var c=void 0===d?a.o:null===d?a.i:"boolean"===typeof d?a.g:"number"===typeof d?a.j:"string"===typeof d?a.l:"function"===typeof d?a.h:"symbol"===typeof d?a.m:d instanceof Map?a.Map:d instanceof Set?a.Set:Array.isArray(d)?a.Array:(c=Object.getPrototypeOf(d))&&c!==Object.prototype?a.instance:a.object;var m=g,q=n,v=e.length;g=d;n=u;c(d,h)?0<=n&&l.set(d,~n):0>n&&l.delete(d);if(v===e.length)throw Error("Value encoded into nothing "+String(d));g=m;n=q}function h(d,
c){if(c===p)e.push(d);else if(c===r)d===(d|0)&&e.push(0),e.push(d);else if(c===w)k.push(e.push(d)-1);else if(c===x){c=k.pop();var m=e.length,q=m<<3|e[c];if(q>>3!==m)throw Error("value too large to encode "+String(d));e[c]=q}else if(d===t)g!==p&&(0<=n&&(n=~n),l.set(g,n),g=p);else if(0<=n&&(n=~n,l.set(g,0)),u++,c=l.get(d),null!=c){if(0===c)throw Error("infinite loop when encoding "+d);e.push(c)}else f(d)}var e=[],l=new Map,k=[],u=0,n=0,g=p;f(b);return e}}function z(a,b){b(void 0,p)}
function A(a,b){b(null,p)}function C(a,b){b(a,p)}function D(a,b){if(a===(a|0))return b(a,r),!0;b(a,p);return a===a}function E(a,b){b(t);b(1,w);for(var f=a.length,h=0;h<f;h++)b(a[h]);b(a,x);return!0}function F(a,b){b(a,p);return!0}function G(a,b){b(t);b(3,w);a.forEach(function(f,h){b(h)});b(a,x);a.forEach(function(f){b(f)});return!0}function H(a,b){b(t);b(4,w);a.forEach(function(f){b(f)});b(a,x);return!0}
function I(a,b){b(t);b(2,w);for(var f=Object.keys(a),h=f.length,e=0;e<h;e++)b(f[e]);b(a,x);for(e=0;e<h;e++)b(a[f[e]]);return!0}function J(a,b){return a?function(f,h){h(5,w);var e=a(f,h);h(f,x);return e}:b}
function K(a,b,f,h){if(h!==(h|0))return h;if(0>h)return a[~h];switch(h&7){case 0:return f();case 1:var e=[];a.push(e);L(a,e,b,f,h>>3);return p;case 2:e={};a.push(e);var l=[];L(a,l,b,f,h>>3);h=l.length;for(var k=0;k<h;k++)e[l[k]]=M(a,b,f);return p;case 3:e=new Map;a.push(e);l=[];L(a,l,b,f,h>>3);h=l.length;for(k=0;k<h;k++)e.set(l[k],M(a,b,f));return p;case 4:e=new Set;a.push(e);l=[];L(a,l,b,f,h>>3);h=l.length;for(k=0;k<h;k++)e.add(l[k]);return p;case 5:return b(function(){return M(a,b,f)});default:throw Error("Rebuilder TODO "+
h);}}function M(a,b,f){var h=a.length;b=K(a,b,f,f());if(b===p)return a[h];a.push(b);return b}function L(a,b,f,h,e){for(var l=h(e);l!==x;l=h(e)){var k=a.length;l=K(a,f,h,l);l===p?b.push(a[k]):(a.push(l),b.push(l))}};function N(a){throw Error("No way to atomize "+String(a));}function O(a,b){b(a,r);return!0}export const AS_IS=r;export const atomizer=function(a){a=void 0===a?{}:a;var b=a.keepUnknownsAsIs?O:N;return y({o:J(a["void"],z),i:J(a["null"],A),g:J(a["boolean"],C),j:J(a.number,D),Array:J(a.Array,E),l:J(a.string,F),Map:J(a.Map,G),Set:J(a.Set,H),object:J(a.object,I),h:J(a["function"],b),m:J(a.symbol,b),instance:J(a.instance,b)})};
export const rebuilder=function(a){return function(b){var f=0,h=b.length,e=M([],a,function(l){if(f===l)return x;if(f===h)throw Error("Incomplete data");return b[f++]});if(f!==h)throw Error("rebuilder given excess content");return e}};
export const serialize=function(a){function b(){var d=a[l++];if(0===d||d!==(d|0)){var c=0===d?a[l++]:d;if(c!==c)f(80);else if(void 0===c)f(16);else if(null===c)f(32);else if("boolean"===typeof c)f(c?48:64);else if("number"===typeof c)if(c===(c|0)){c=0<=c?c<<1:-c<<1|1;var m=127&c<<3|4;if(c>>>=4){for(d=[m|128];c;)m=c&127,c>>>=7,d.push(c?m|128:m);k+=d.length;e.push(new Uint8Array(d))}else f(m)}else m=new Uint8Array(8),(new DataView(m.buffer)).setFloat64(0,c),f(96),k+=8,e.push(m);else"string"===typeof c?
(u||(u=new TextEncoder),m=h(13),c=u.encode(c),k+=c.byteLength,e.push(c),m()):console.error("TODO serialize "+String(c))}else if(0>d){c=~d<<2|2;do m=c&127,c>>>=7,f(c?m|128:m);while(c)}else{var q=d&7;c=d>>3;m=h(q<<1|1);switch(q){case 1:case 4:case 5:for(;l<c;)b();m();break;case 2:case 3:for(d=0;l<c;)d++,b();m();for(c=d;0<c;c--)b();break;default:throw Error("impossible "+d);}}}function f(d){k++;e.push(d)}function h(d){var c=e.push(0)-1,m=k;return function(){var q=k-m,v=127&q<<4|d;if(q>>>=3){for(var B=
[v|128];q;)v=q&127,q>>>=7,B.push(q?v|128:v);k+=B.length;e[c]=new Uint8Array(B)}else k++,e[c]=v}}var e=[],l=0,k=0,u=null;b();var n=new Uint8Array(k),g=0;e.forEach(function(d){"number"===typeof d?n[g++]=d:(n.set(d,g),g+=d.byteLength)});return n};
export const deserializer=function(a){var b=null;return function(f){function h(g){if(null!=n)return g=n,n=null,g;if(k===g)return x;if(k===u)throw Error("Incomplete data");g=f[k++];if(g&1)switch(g&15){case 13:g=e(g,4);g=k+g;var d=f.subarray(k,g);k=g;b||(b=new TextDecoder);return b.decode(d);default:return d=e(g,4),k+d<<3|7&g>>1}else{if(g&2)return~e(g,2);if(g&4)return g=e(g,3),n=g&1?-(g>>>1):g>>>1,0;switch(g){case 16:break;case 32:return null;case 48:return!0;case 64:return!1;case 80:return NaN;case 96:return l||
(l=new DataView(f.buffer,f.byteOffset,f.byteLength)),g=l.getFloat64(k),k+=8,g;default:throw Error("bad byte "+g);}}}function e(g,d){var c=7-d;for(d=(127&g)>>d;g&128;)g=f[k++],d|=(g&127)<<c,c+=7;return d}var l=null,k=0,u=f.length,n=null;return M([],a,function(g){var d=k;g=h(g);if(k<d)throw"fail";return g})}};
