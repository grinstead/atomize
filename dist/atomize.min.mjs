var n={},p={},q={},r={},t={};
function v(a){return function(b){function c(f){var k=void 0===f?a.o:null===f?a.i:"boolean"===typeof f?a.g:"number"===typeof f?a.j:"string"===typeof f?a.l:"function"===typeof f?a.h:"symbol"===typeof f?a.m:f instanceof Map?a.Map:f instanceof Set?a.Set:Array.isArray(f)?a.Array:(k=Object.getPrototypeOf(f))&&k!==Object.prototype?a.instance:a.object;var w=g,x=m,D=e.length;g=f;m=u;k(f,d)?0<=m&&h.set(f,~m):0>m&&h.delete(f);if(D===e.length)throw Error("Value encoded into nothing "+String(f));g=w;m=x}function d(f,
k){if(k===n)e.push(f);else if(k===p)f===(f|0)&&e.push(0),e.push(f);else if(k===r)l.push(e.push(f)-1);else if(k===t){k=l.pop();var w=e.length,x=w<<3|e[k];if(x>>3!==w)throw Error("value too large to encode "+String(f));e[k]=x}else if(f===q)g!==n&&(0<=m&&(m=~m),h.set(g,m),g=n);else if(0<=m&&(m=~m,h.set(g,0)),u++,k=h.get(f),null!=k){if(0===k)throw Error("infinite loop when encoding "+f);e.push(k)}else c(f)}var e=[],h=new Map,l=[],u=0,m=0,g=n;c(b);return e}}function y(a,b){b(void 0,n)}
function z(a,b){b(null,n)}function A(a,b){b(a,n)}function B(a,b){if(a===(a|0))return b(a,p),!0;b(a,n);return a===a}function C(a,b){b(q);b(1,r);for(var c=a.length,d=0;d<c;d++)b(a[d]);b(a,t);return!0}function E(a,b){b(a,n);return!0}function F(a,b){b(q);b(3,r);a.forEach(function(c,d){b(d)});b(a,t);a.forEach(function(c){b(c)});return!0}function G(a,b){b(q);b(4,r);a.forEach(function(c){b(c)});b(a,t);return!0}
function H(a,b){b(q);b(2,r);for(var c=Object.keys(a),d=c.length,e=0;e<d;e++)b(c[e]);b(a,t);for(e=0;e<d;e++)b(a[c[e]]);return!0}function I(a,b){return a?function(c,d){d(5,r);var e=a(c,d);d(c,t);return e}:b}
function J(a,b,c,d){if(d!==(d|0))return d;if(0>d)return a[~d];switch(d&7){case 0:return c();case 1:var e=[];a.push(e);K(a,e,b,c,d>>3);return n;case 2:e={};a.push(e);var h=[];K(a,h,b,c,d>>3);d=h.length;for(var l=0;l<d;l++)e[h[l]]=L(a,b,c);return n;case 3:e=new Map;a.push(e);h=[];K(a,h,b,c,d>>3);d=h.length;for(l=0;l<d;l++)e.set(h[l],L(a,b,c));return n;case 4:e=new Set;a.push(e);h=[];K(a,h,b,c,d>>3);d=h.length;for(l=0;l<d;l++)e.add(h[l]);return n;case 5:return b(function(){return L(a,b,c)});default:throw Error("Rebuilder TODO "+
d);}}function L(a,b,c){var d=a.length;b=J(a,b,c,c());if(b===n)return a[d];a.push(b);return b}function K(a,b,c,d,e){for(var h=d(e);h!==t;h=d(e)){var l=a.length;h=J(a,c,d,h);h===n?b.push(a[l]):(a.push(h),b.push(h))}}function M(a,b){do{var c=a&127;a>>>=7;b(a?c|128:c)}while(a)};function N(a){throw Error("No way to atomize "+String(a));}function O(a,b){b(a,p);return!0}export const AS_IS=p;export const atomizer=function(a){a=void 0===a?{}:a;var b=a.keepUnknownsAsIs?O:N;return v({o:I(a["void"],y),i:I(a["null"],z),g:I(a["boolean"],A),j:I(a.number,B),Array:I(a.Array,C),l:I(a.string,E),Map:I(a.Map,F),Set:I(a.Set,G),object:I(a.object,H),h:I(a["function"],b),m:I(a.symbol,b),instance:I(a.instance,b)})};
export const rebuilder=function(a){return function(b){var c=0,d=b.length,e=L([],a,function(h){if(c===h)return t;if(c===d)throw Error("Incomplete data");return b[c++]});if(c!==d)throw Error("rebuilder given excess content");return e}};
export const serialize=function(a){function b(){var g=a[e++];if(g===p||g!==(g|0)){var f=g===p?a[e++]:g;if(f!==f)c(4);else if(void 0===f)c(0);else if(null===f)c(1);else if("boolean"===typeof g)c(g?2:3);else if("string"===typeof g)l||(l=new TextEncoder),g=l.encode(g),f=g.byteLength,M(g.byteLength,c),h+=f,d.push(g);else throw Error("TODO serialize "+String(g));}else if(0>g)M(~g<<1|1,c);else switch(M(g<<1,c),f=g>>3,g&7){case 1:case 4:for(;e<f;)b();break;case 2:case 3:for(g=0;e<f;)g++,b();for(;0<g;g--)b();
break;case 5:for(;e<f;)b()}}function c(g){h++;d.push(g)}var d=[],e=0,h=0,l=null;b();var u=new Uint8Array(h),m=0;d.forEach(function(g){"number"===typeof g?u[m++]=g:(u.set(g,m),m+=g.byteLength)});return u};
